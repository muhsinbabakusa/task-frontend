<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Task Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">

  <style>
    :root{
      --brand:#337F5E;
      --bg:#f6f7f8;
      --card:#ffffff;
      --text:#222;
      --muted:#6b7280;
      --ring: rgba(51,127,94,.15);
      --shadow:0 6px 20px rgba(0,0,0,.06);
      --radius:22px;
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    /* Header */
    .header{
      position:sticky; top:0; z-index:10;
      background: linear-gradient(0deg, #f6f7f8 0%, #ffffff 100%);
      border-bottom: 1px solid #eee;
    }
    .header-inner{
      max-width: 1100px; margin: 0 auto; padding: 10px 14px;
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .brand{
      display:flex; align-items:center; gap:2px; margin:auto;
    }
    .brand img{
      height:55px; width:auto; display:block;
    }
    .brand h1{
      font-size: 30px; font-weight:700; margin:0; color: var(--brand);
      letter-spacing:.3px;
    }
    .header-actions{
      display:flex; gap:10px; align-items:center;
      position:absolute; right:16px;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      height:42px; padding:0 16px; border-radius:12px; border:2px solid var(--brand);
      color:#fff; background:var(--brand); cursor:pointer; font-weight:600;
      transition:.2s ease; box-shadow: var(--shadow);
    }
    .btn:hover{ 
      background:#fff;
      color:var(--brand); 
      transition: 1s;
      
      }
    .btn.secondary{
      background:#fff; color:var(--brand);
      transition: 1s;
    }
    .btn.secondary:hover{
      background:#f2fbf7;
      transition: 1s;
    }

    /* Page container */
    .page{
     margin:20px auto; padding: 0 16px;
    }
    @media (max-width: 900px){
      .page{ grid-template-columns: 1fr; }
      .brand{ margin: 0; }

          .filters{ 
     display: flex;
     gap: 0;
     flex-wrap: wrap;
    }



    }

    /* Card */
    .card{
      background:var(--card); 
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      border:1px solid #eee;
    }

    /* Create/Edit form (card inside the modal) */
    .form{
      padding:16px;
    }
    .form h2{
      margin:8px 0 14px; font-size:20px; color: var(--brand);
    }
    .row{ display:flex; gap:10px; }
    .field{
      display:flex; flex-direction:column; margin-bottom:12px;
    }
    .field label{
      font-size: 12px; color: var(--muted); margin-bottom:6px;
    }
    .input, select, .date{
      width:100%; height:44px; border-radius:12px; padding:10px 12px;
      border:1.5px solid #e5e7eb; outline:none; background:#fff; font: inherit;
      transition:border .15s ease, box-shadow .15s ease;
    }
    .input:focus, select:focus, .date:focus{
      border-color: var(--brand); box-shadow: 0 0 0 6px var(--ring);
    }
    textarea.input{
      min-height: 90px; resize: vertical; line-height:1.4;
    }
    .actions{
      display:flex; gap:10px; justify-content:flex-end; margin-top:8px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px; font-size:12px;
      padding:6px 10px; border-radius:999px; background:#f0fdf4; color:var(--brand);
      border:1px solid #c0e6d7;
    }

    /* Tasks grid */
    .tasks{
      padding:16px;
     
    }
    .tasks-head{
      display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;
    }
    .grid{
      display:grid; gap:14px;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    }
    .task{
      padding:16px; border-radius: 18px; border:1px solid #eee; box-shadow: var(--shadow);
      background:#fff; display:flex; flex-direction:column; gap:8px;
    }
    .task h3{ margin:0; font-size:18px; }
    .muted{ color: var(--muted); font-size: 13px; }
    .task .meta{ display:flex; gap:8px; flex-wrap:wrap; }
    .task .row-actions{ display:flex; gap:8px; margin-top:6px; flex-wrap:wrap; }
    .chip{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
      background:#f8fafc; border:1px solid #eef2f7; font-size:12px; color:#374151;
    }
    .chip.warn{ background:#fff7ed; border-color:#fde7d6; color:#9a3412; }
    .chip.ok{ background:#ecfdf5; border-color:#c7f0e2; color:#065f46; }
    .empty{
      text-align:center; padding:30px 12px; color: var(--muted);
    }

    /* Toast */
    .toast{
      position:fixed; right:16px; bottom:16px; z-index:50;
      padding:12px 16px; background:#111827; color:#fff; border-radius:12px;
      box-shadow: var(--shadow); opacity:0; transform: translateY(10px);
      transition: .2s ease;
    }
    .toast.show{ opacity:1; transform: translateY(0); }


    .toolbar{
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px 18px;
      flex-wrap: wrap;
    }

    .filters{ 
     display: flex;
     gap: 8px;
     flex-wrap: wrap;
    }
.pill{
  border:1px solid #e5e7eb; background:#fff; color:#374151;
      padding: 7px 7px; border-radius:999px; font: inherit; cursor:pointer;
  transition:.15s ease; outline:none;
}
.pill:hover{ background:#f8fafc; }
.pill.active{ border-color:var(--brand); color:var(--brand); box-shadow:0 0 0 4px var(--ring); }

.search{
  position:relative; min-width:220px; flex:1; max-width:410px;
}
.search i{ 
  position:absolute;
  left:10px; top:50%; 
  transform:translateY(-50%);
  font-size:18px; 
   color:var(--muted); 
  }
.search input{
  width:100%; height:40px; border-radius:12px; padding:0 36px 0 36px;
  border:1.5px solid #e5e7eb; outline:none; background:#fff; font: inherit;
  transition:border .15s ease, box-shadow .15s ease;
}
.search input:focus{ border-color:var(--brand); box-shadow:0 0 0 6px var(--ring); }
.search .clear{
  position:absolute; right:6px; top:50%; transform:translateY(-50%);
  border:none; background:transparent; cursor:pointer; height:36px; width:36px; border-radius:8px;
}
.search .clear:hover{ 
  background:#f3f4f6;
 }

/* Overdue task highlight */
.task.overdue{
  border-color:#fecaca;
  box-shadow:0 6px 20px rgba(239,68,68,.10);
}
.task.done{
  border-color:#73fe6c;
  box-shadow:0 6px 20px rgba(239,68,68,.10);
}
.task.done .chip:last-child{ /* done chip */
  background:#73fe6c; border-color:#73fe6c; color:#b91c1c;
}
.task.overdue .chip:last-child{ /* deadline chip */
  background:#fef2f2; border-color:#fee2e2; color:#b91c1c;
}

/* Loading skeletons */
.skeleton{
  border-radius:18px; border:1px solid #eee; background:linear-gradient(90deg,#f6f7f8 25%,#eceff3 37%,#f6f7f8 63%);
  background-size:400% 100%; animation:sheen 1.2s ease-in-out infinite;
  height:140px;
}
@keyframes sheen{ 0%{background-position:100% 0} 100%{background-position:-100% 0} }

/* small create button */
.btn.small {
  height: 36px;
  padding: 0 12px;
  font-size: 14px;
  border-radius: 8px;
}

/* Modal-like behavior for the existing form (keeps layout intact) */
#taskFormSection {
  position: fixed;      /* remove from flow */
  inset: 0;             /* top/right/bottom/left: 0 */
  display: none;        /* hidden by default */
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.35);
  z-index: 70;
  padding: 24px;
}
#taskFormSection .card.form {
  max-width: 520px;
  width: 100%;
  margin: 0;
}
#taskFormSection.show {
  display: flex !important;
}
  </style>
</head>
<body>


  <header class="header">
    <div class="header-inner">
      <div class="brand">
       
        <img src="LogoDesign_BolTwithCheckmark.png" alt="Logo">
        <h1>Tick</h1>
      </div>
      <div class="header-actions">
        <button id="logoutBtn" class="btn secondary"><i class='bx bx-log-out'></i> Logout</button>
      </div>
    </div>
  </header>


  <main class="page">
   <section id="taskFormSection">
  <div class="card form"> <!-- inner wrapper keeps styling -->
    <h2 id="formHeading">Create Task</h2>

    <div class="field">
      <label for="title">Title *</label>
      <input id="title" class="input" placeholder="e.g. Send invoice to client" required />
    </div>

    <div class="field">
      <label for="description">Description</label>
      <textarea id="description" class="input" placeholder="Optional notes..."></textarea>
    </div>

    <div class="row">
      <div class="field" style="flex:1">
        <label for="priority">Priority</label>
        <select id="priority">
          <option value="low">Low</option>
          <option value="medium" selected>Medium</option>
          <option value="high">High</option>
        </select>
      </div>
      <div class="field" style="flex:1">
        <label for="deadline">Deadline</label>
        <input id="deadline" type="date" class="date" />
      </div>
    </div>

    <input type="hidden" id="editTaskId" />
    <div class="actions">
      <button id="cancelEdit" class="btn secondary" style="display:none">Cancel</button>
      <button id="submitBtn" class="btn">
        <i class='bx bx-plus-circle'></i><span>Save Task</span>
      </button>
    </div>
    <div style="margin-top:10px">
      <span class="badge"><i class='bx bx-info-circle'></i> Tip: click a task’s ✏️ to edit</span>
    </div>
  </div>
</section>

    <!-- Tasks -->
    <section class="card tasks">
      <div class="tasks-head">
        <h2 style="margin:0; color:var(--brand)"> </h2>
        <span id="counter" class="chip">0 tasks</span>
      </div>

      <!-- NEW: toolbar (Create button inserted in filters section) -->
  <div class="toolbar">
    <div class="filters" role="tablist" aria-label="Task filters">
      <button class="pill active" data-filter="all"    onclick="setFilter('all')"    aria-selected="true">All</button>
      <button class="pill"         data-filter="pending" onclick="setFilter('pending')">Pending</button>
      <button class="pill"         data-filter="done"    onclick="setFilter('done')">Done</button>
      <button class="pill"         data-filter="overdue" onclick="setFilter('overdue')">Overdue</button>

      <!-- create button inside filters -->
      <button id="createTaskBtn" class="btn small" style="margin-left:8px">
        <i class='bx bx-plus-circle'></i> <span>Create Task</span>
      </button>
    </div>

    <div class="search">
      <i class='bx bx-search'></i>
      <input id="searchBox" type="search" placeholder="Search tasks…" oninput="setQuery(this.value)">
      <button class="clear" title="Clear" onclick="clearQuery()" aria-label="Clear search"><i class='bx bx-x'></i></button>
    </div>
  </div>

      <div id="userList" class="grid">
        <div class="empty">Loading tasks…</div>
      </div>
    </section>
  </main>

  <!-- Toast -->
  <div id="toast" class="toast">Saved</div>

  <script>
    const API_BASE = "https://task-manager-8d1z.onrender.com";
    const token = localStorage.getItem("access_token");

    if (!token) {
      window.location.href = "index.html";
    }

    // Elements (kept as in your original structure)
    const userList   = document.getElementById("userList");
    const counter    = document.getElementById("counter");
    const formHeading= document.getElementById("formHeading");
    const titleEl    = document.getElementById("title");
    const descEl     = document.getElementById("description");
    const prioEl     = document.getElementById("priority");
    const dateEl     = document.getElementById("deadline");
    const editIdEl   = document.getElementById("editTaskId");
    const submitBtn  = document.getElementById("submitBtn");
    const cancelBtn  = document.getElementById("cancelEdit");
    const toastEl    = document.getElementById("toast");

    // references for create button + the modal-like form
    const createBtn    = document.getElementById("createTaskBtn");
    const formSection  = document.getElementById("taskFormSection");

    function toast(msg){
      toastEl.textContent = msg;
      toastEl.classList.add("show");
      setTimeout(()=>toastEl.classList.remove("show"), 1800);
    }

    // Logout
    document.getElementById("logoutBtn").addEventListener("click", ()=>{
      localStorage.removeItem("access_token");
      window.location.href = "index.html";
    });

    // Load tasks
    async function loadTasks(){
      userList.innerHTML = `<div class="empty">Loading tasks…</div>`;
      try{
        const res = await fetch(`${API_BASE}/get_task`, {
          headers: { "Authorization": "Bearer " + token }
        });
        if(!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();
        renderTasks(data.tasks || []);
      }catch(e){
        console.error(e);
        userList.innerHTML = `<div class="empty" style="color:#b91c1c">Failed to load tasks. Please log in again.</div>`;
      }
    }

    // helpers used by rendering & filtering
    function escapeHtml(str){
      return String(str ?? "").replace(/[&<>"']/g, s=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[s]));
    }
    function encodeTask(task){
      return JSON.stringify(task).replace(/</g,"\\u003c").replace(/>/g,"\\u003e").replace(/"/g,'&quot;');
    }

    function normalize(s){
      return String(s||'').toLowerCase();
    }
    function matchesQuery(task, q){
      if (!q) return true;
      const t = normalize(task.title);
      const d = normalize(task.description);
      return t.includes(q) || d.includes(q);
    }

    // overdue detection
    function isDone(task){
      const status = (task.status || (task.completed ? 'Done' : 'pending')).toLowerCase();
      return status === 'done';
    }

    function isOverdue(task){
      if (!task.deadline) return false;
      const dateStr = String(task.deadline).split('T')[0];
      if (!dateStr || dateStr === 'None') return false;
      const today = new Date(); today.setHours(0,0,0,0);
      const d = new Date(dateStr); d.setHours(0,0,0,0);
      return d < today && !isDone(task);
    }

    // render tasks (keeps your original markup)
    function renderTasks(tasks, opts={ total: tasks.length }){
      const total = opts.total ?? tasks.length;

      if(!tasks.length){
        userList.innerHTML = `<div class="empty">No tasks match your filters — try clearing search or switching filter.</div>`;
        counter.textContent = `${tasks.length} of ${total} ${total===1?'task':'tasks'}`;
        return;
      }
      counter.textContent = `${tasks.length} of ${total} ${total===1?'task':'tasks'}`;

      userList.innerHTML = "";
      tasks.forEach(task=>{
        const div = document.createElement("div");
        div.className = "task";
        if (isOverdue(task)) div.classList.add('overdue');
        if (isDone(task)) div.classList.add('done');

        const deadline = task.deadline ? String(task.deadline).split("T")[0] : "None";
        const status = task.status || (task.completed ? "Done" : "pending");

        div.innerHTML = `
          <h3>${escapeHtml(task.title)}</h3>
          ${task.description ? `<div class="muted">${escapeHtml(task.description)}</div>` : ""}
          <div class="meta">
            <span class="chip"><i class='bx bxs-flag'></i> Priority: ${escapeHtml(task.priority || "medium")}</span>
            <span class="chip ${status.toLowerCase()==='done'?'ok':'warn'}"><i class='bx bx-check-shield'></i> ${escapeHtml(status)}</span>
            <span class="chip"><i class='bx bx-calendar'></i> Deadline: ${escapeHtml(deadline)}</span>
          </div>
          <div class="row-actions">
            <button class="btn secondary" onclick='startEdit(${task.id}, ${encodeTask(task)})'><i class="bx bx-edit-alt"></i> Edit</button>
            <button class="btn" style="background:#0ea5e9;border-color:#0ea5e9" onclick="markDone(${task.id})"><i class='bx bx-check'></i> Done</button>
            <button class="btn" style="background:#ef4444;border-color:#ef4444" onclick="deleteTask(${task.id})"><i class='bx bx-trash'></i> Delete</button>
          </div>
        `;
        userList.appendChild(div);
      });
    }

    // Actions
    async function markDone(id){
      try{
        const res = await fetch(`${API_BASE}/mark_done?task_id=${id}`, {
          method:"PATCH",
          headers:{ "Authorization":"Bearer " + token }
        });
        const data = await res.json();
        toast(data.message || "Marked done");
        await loadTasks();
      }catch(e){
        alert("Failed to mark as done.");
      }
    }

    async function deleteTask(id){
      if(!confirm("Delete this task?")) return;
      try{
        const res = await fetch(`${API_BASE}/delete_task?task_id=${id}`, {
          method:"DELETE",
          headers:{ "Authorization":"Bearer " + token }
        });
        const data = await res.json();
        toast(data.message || "Deleted");
        await loadTasks();
      }catch(e){
        alert("Failed to delete task.");
      }
    }

    // Create / Update (keep your original logic; hide modal on success)
    submitBtn.addEventListener("click", async (e)=>{
      e.preventDefault();
      const title = titleEl.value.trim();
      if(!title){ titleEl.focus(); return; }

      const payload = {
        title,
        description: descEl.value.trim(),
        priority: prioEl.value,
        deadline: dateEl.value || null
      };

      const editId = editIdEl.value;
      const editing = !!editId;

      submitBtn.disabled = true;
      submitBtn.querySelector("span").textContent = editing ? "Updating..." : "Creating...";

      try{
        const url = editing ? `${API_BASE}/update_task/${editId}` : `${API_BASE}/create_task`;
        const method = editing ? "PUT" : "POST";

        const res = await fetch(url, {
          method,
          headers:{
            "Authorization":"Bearer " + token,
            "Content-Type":"application/json"
          },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(()=>({}));

        if(!res.ok){
          alert("Failed to save: " + (data.detail || data.message || ("HTTP "+res.status)));
        }else{
          toast(editing ? "Task updated" : "Task created");
          resetForm();
          // hide modal and show create button again
          formSection.classList.remove("show");
          createBtn.classList.remove("hidden");
          await loadTasks();
        }
      }catch(err){
        alert("Failed to save task.");
      }finally{
        submitBtn.disabled = false;
        submitBtn.querySelector("span").textContent = "Save Task";
      }
    });

    function resetForm(){
      editIdEl.value = "";
      titleEl.value = "";
      descEl.value = "";
      prioEl.value = "medium";
      dateEl.value = "";
      formHeading.textContent = "Create Task";
      cancelBtn.style.display = "none";
    }

    cancelBtn.addEventListener("click", (e)=>{
      e.preventDefault();
      resetForm();
      formSection.classList.remove("show");
      createBtn.classList.remove("hidden");
    });

    // Expose for inline onclick
    window.startEdit = function(id, task){
      if (typeof task === "string"){
        try{ task = JSON.parse(task.replace(/&quot;/g,'"')); }catch{}
      }
      titleEl.value = task.title || "";
      descEl.value = task.description || "";
      prioEl.value = task.priority || "medium";
      dateEl.value = (task.deadline && task.deadline !== "None") ? String(task.deadline).split("T")[0] : "";
      editIdEl.value = id;

      formHeading.textContent = "Edit Task";
      cancelBtn.style.display = "inline-flex";
      // show modal for editing
      formSection.classList.add("show");
      createBtn.classList.add("hidden");
      titleEl.scrollIntoView({behavior:"smooth", block:"center"});
    };


    let allTasks = [];             // cache full list from server
    let currentFilter = 'all';     // 'all' | 'pending' | 'done' | 'overdue'
    let currentQuery  = ''; 

    // apply & render pipeline
    function applyAndRender(){
      let list = allTasks.slice();
      overdue

      // filter
      if (currentFilter === 'pending') list = list.filter(t => !isDone(t));
      if (currentFilter === 'done')    list = list.filter(t => isDone(t));
      if (currentFilter === 'overdue') list = list.filter(t => isOverdue(t));

      // search
      const q = normalize(currentQuery.trim());
      if (q) list = list.filter(t => matchesQuery(t, q));

      renderTasks(list, { total: allTasks.length });
    }

    function setFilter(name){
      currentFilter = name;
      document.querySelectorAll('.pill').forEach(p=>{
        const active = p.getAttribute('data-filter') === name;
        p.classList.toggle('active', active);
        p.setAttribute('aria-selected', String(active));
      });
      applyAndRender();
    }

    function setQuery(val){
      currentQuery = val;
      applyAndRender();
    }

    function clearQuery(){
      currentQuery = '';
      const box = document.getElementById('searchBox');
      if (box){ box.value = ''; box.focus(); }
      applyAndRender();
    }

    
  

    // show modal when create button clicked
    createBtn?.addEventListener("click", (e) => {
      e.preventDefault();
      formSection?.classList.add("show");
      createBtn?.classList.add("hidden");
      cancelBtn.style.display = "inline-flex";
      formHeading.textContent = "Create Task";
      titleEl.scrollIntoView({ behavior: "smooth", block: "center" });
    });

    // close modal by clicking overlay outside card
    formSection?.addEventListener("click", (e) => {
      if (e.target === formSection){
        resetForm();
        formSection.classList.remove("show");
        createBtn.classList.remove("hidden");
      }
    });

    // Go!
    loadTasks();
  </script>
</body>
</html>
